<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Windows 11 Web - 繁體中文版</title>
    <meta name="description" content="A pixel-perfect Windows 11 clone in Traditional Chinese built with vanilla HTML/JS">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Noto Sans TC for authentic Traditional Chinese typography -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- System & Reset --- */
        :root {
            --bg-color: #f3f3f3;
            --taskbar-color: rgba(243, 243, 243, 0.85);
            --window-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.5);
            --hover-bg: rgba(255, 255, 255, 0.5);
            --active-bg: rgba(255, 255, 255, 0.7);
            --system-blue: #0067c0;
        }

        body {
            font-family: 'Segoe UI', 'Noto Sans TC', sans-serif;
            overflow: hidden;
            user-select: none;
            -webkit-font-smoothing: antialiased;
            cursor: default;
        }

        /* --- Custom Utilities --- */
        .glass {
            background: rgba(249, 250, 251, 0.75);
            backdrop-filter: blur(20px) saturate(125%);
            -webkit-backdrop-filter: blur(20px) saturate(125%);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .glass-dark {
            background: rgba(32, 32, 32, 0.75);
            backdrop-filter: blur(20px) saturate(125%);
            -webkit-backdrop-filter: blur(20px) saturate(125%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mica-effect {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(50px) saturate(150%); 
        }

        .shadow-win11 {
            box-shadow: 0 0 0 1px rgba(0,0,0,0.05), 0 10px 25px -5px rgba(0,0,0,0.2), 0 8px 10px -6px rgba(0,0,0,0.1);
        }

        .taskbar-icon-hover:hover {
            background-color: rgba(255, 255, 255, 0.5);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2);
        }

        .start-menu-anim {
            transition: transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.2s;
            transform-origin: bottom center;
        }
        
        .start-menu-hidden {
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            pointer-events: none;
        }

        .window-frame {
            position: absolute;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25), 0 0 0 1px rgba(0,0,0,0.08);
            transition: transform 0.15s, opacity 0.15s, width 0.2s, height 0.2s, top 0.2s, left 0.2s;
            min-width: 300px;
            min-height: 200px;
            /* CRITICAL FIX: Enable pointer events for windows so clicks don't pass through */
            pointer-events: auto; 
        }

        .window-opening {
            animation: openWindow 0.2s cubic-bezier(0.1, 0.9, 0.2, 1) forwards;
        }

        .window-closing {
            animation: closeWindow 0.15s ease-in forwards;
        }

        @keyframes openWindow {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes closeWindow {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(0.95); opacity: 0; }
        }

        .app-grid-item:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        .app-grid-item:active {
            background-color: rgba(255, 255, 255, 0.4);
            transform: scale(0.98);
        }

        /* Desktop Grid */
        #desktop {
            display: grid;
            grid-template-columns: repeat(auto-fill, 96px);
            grid-template-rows: repeat(auto-fill, 104px);
            grid-auto-flow: column;
            height: calc(100vh - 48px);
            padding: 4px;
            align-content: start;
        }

        .desktop-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            padding: 8px 4px;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.8);
            cursor: default;
            border: 1px solid transparent;
            transition: background 0.1s;
        }

        .desktop-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .desktop-icon.selected {
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }
        .scrollbar-thin:hover::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.3);
        }

        /* Boot Screen */
        #boot-screen {
            z-index: 9999;
            background: black;
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-black">

    <!-- 1. Boot Screen -->
    <div id="boot-screen" class="fixed inset-0 flex flex-col items-center justify-center text-white transition-opacity duration-1000">
        <i class="fa-brands fa-windows text-6xl mb-8 text-blue-500"></i>
        <div class="w-8 h-8 border-4 border-t-blue-500 border-r-transparent border-b-transparent border-l-transparent rounded-full animate-spin"></div>
    </div>

    <!-- 2. Wallpaper Background -->
    <div id="wallpaper" class="absolute inset-0 bg-cover bg-center z-0 transition-all duration-500" style="background-image: url('https://images.unsplash.com/photo-1633205719979-e47958b27d7b?q=80&w=2670&auto=format&fit=crop');"></div>

    <!-- 3. Desktop Icons Container -->
    <div id="desktop" class="relative z-10 w-full">
        <!-- Icons will be injected via JS -->
    </div>

    <!-- 4. Windows Container (Where Apps Open) -->
    <div id="windows-container" class="absolute inset-0 pointer-events-none z-20 overflow-hidden">
        <!-- Windows injected here -->
    </div>

    <!-- 5. Context Menu (Right Click) -->
    <div id="context-menu" class="fixed hidden glass w-64 rounded-lg shadow-win11 py-1 z-50 text-sm text-gray-800 transform scale-95 opacity-0 transition-all duration-100">
        <div class="px-1">
            <div class="hover:bg-blue-500 hover:text-white rounded px-3 py-1.5 flex items-center gap-3 cursor-default" onclick="refreshDesktop()">
                <i class="fa-solid fa-rotate-right w-4"></i> 重新整理
            </div>
            <div class="hover:bg-blue-500 hover:text-white rounded px-3 py-1.5 flex items-center gap-3 cursor-default">
                <i class="fa-solid fa-sort w-4"></i> 排序方式
            </div>
            <div class="hover:bg-blue-500 hover:text-white rounded px-3 py-1.5 flex items-center gap-3 cursor-default">
                <i class="fa-regular fa-eye w-4"></i> 檢視
            </div>
        </div>
        <div class="h-px bg-gray-300 my-1 mx-2"></div>
        <div class="px-1">
            <div class="hover:bg-blue-500 hover:text-white rounded px-3 py-1.5 flex items-center gap-3 cursor-default">
                <i class="fa-solid fa-display w-4"></i> 顯示設定
            </div>
            <div class="hover:bg-blue-500 hover:text-white rounded px-3 py-1.5 flex items-center gap-3 cursor-default" onclick="openApp('settings')">
                <i class="fa-solid fa-wand-magic-sparkles w-4"></i> 個人化
            </div>
        </div>
        <div class="h-px bg-gray-300 my-1 mx-2"></div>
        <div class="px-1">
            <div class="hover:bg-blue-500 hover:text-white rounded px-3 py-1.5 flex items-center gap-3 cursor-default">
                <i class="fa-solid fa-terminal w-4"></i> 在終端機中開啟
            </div>
            <div class="hover:bg-blue-500 hover:text-white rounded px-3 py-1.5 flex items-center gap-3 cursor-default">
                <i class="fa-regular fa-folder-open w-4"></i> 新增資料夾
            </div>
        </div>
    </div>

    <!-- 6. Start Menu -->
    <div id="start-menu" class="fixed bottom-14 left-1/2 transform -translate-x-1/2 w-[640px] h-[700px] glass rounded-lg shadow-2xl z-50 flex flex-col start-menu-hidden start-menu-anim p-6 select-none">
        <!-- Search Bar -->
        <div class="relative mb-6">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-500"></i>
            <input type="text" placeholder="搜尋應用程式、設定和文件" class="w-full bg-[#f3f3f3] border-none rounded py-2 pl-10 pr-4 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
        </div>

        <!-- Pinned Section -->
        <div class="flex justify-between items-center mb-4">
            <span class="text-sm font-bold text-gray-700">已釘選</span>
            <button class="text-xs bg-white border px-2 py-1 rounded hover:bg-gray-50 shadow-sm flex items-center gap-1">所有應用程式 <i class="fa-solid fa-chevron-right text-[10px]"></i></button>
        </div>

        <div class="grid grid-cols-6 gap-4 mb-8">
            <!-- App Icons -->
            <div class="app-grid-item flex flex-col items-center p-2 rounded cursor-pointer" onclick="openApp('edge')">
                <img src="https://upload.wikimedia.org/wikipedia/commons/9/98/Microsoft_Edge_logo_%282019%29.svg" class="w-8 h-8 mb-2" alt="Edge">
                <span class="text-xs text-gray-700">Edge</span>
            </div>
            <div class="app-grid-item flex flex-col items-center p-2 rounded cursor-pointer" onclick="openApp('word')">
                <img src="https://upload.wikimedia.org/wikipedia/commons/f/fd/Microsoft_Office_Word_%282019%E2%80%93present%29.svg" class="w-8 h-8 mb-2" alt="Word">
                <span class="text-xs text-gray-700">Word</span>
            </div>
            <div class="app-grid-item flex flex-col items-center p-2 rounded cursor-pointer" onclick="openApp('excel')">
                <img src="https://upload.wikimedia.org/wikipedia/commons/3/34/Microsoft_Office_Excel_%282019%E2%80%93present%29.svg" class="w-8 h-8 mb-2" alt="Excel">
                <span class="text-xs text-gray-700">Excel</span>
            </div>
             <div class="app-grid-item flex flex-col items-center p-2 rounded cursor-pointer" onclick="openApp('ppt')">
                <img src="https://upload.wikimedia.org/wikipedia/commons/0/0d/Microsoft_Office_PowerPoint_%282019%E2%80%93present%29.svg" class="w-8 h-8 mb-2" alt="PPT">
                <span class="text-xs text-gray-700">PowerPoint</span>
            </div>
            <div class="app-grid-item flex flex-col items-center p-2 rounded cursor-pointer" onclick="openApp('store')">
                <i class="fa-brands fa-windows text-blue-500 text-3xl mb-2"></i>
                <span class="text-xs text-gray-700">Microsoft Store</span>
            </div>
            <div class="app-grid-item flex flex-col items-center p-2 rounded cursor-pointer" onclick="openApp('photos')">
                <i class="fa-solid fa-image text-purple-500 text-3xl mb-2"></i>
                <span class="text-xs text-gray-700">相片</span>
            </div>
             <div class="app-grid-item flex flex-col items-center p-2 rounded cursor-pointer" onclick="openApp('settings')">
                <i class="fa-solid fa-gear text-gray-500 text-3xl mb-2"></i>
                <span class="text-xs text-gray-700">設定</span>
            </div>
            <div class="app-grid-item flex flex-col items-center p-2 rounded cursor-pointer" onclick="openApp('calculator')">
                <i class="fa-solid fa-calculator text-gray-600 text-3xl mb-2"></i>
                <span class="text-xs text-gray-700">小算盤</span>
            </div>
             <div class="app-grid-item flex flex-col items-center p-2 rounded cursor-pointer" onclick="openApp('notepad')">
                <i class="fa-solid fa-note-sticky text-blue-400 text-3xl mb-2"></i>
                <span class="text-xs text-gray-700">記事本</span>
            </div>
             <div class="app-grid-item flex flex-col items-center p-2 rounded cursor-pointer" onclick="openApp('explorer')">
                <i class="fa-solid fa-folder-closed text-yellow-500 text-3xl mb-2"></i>
                <span class="text-xs text-gray-700">檔案總管</span>
            </div>
            <div class="app-grid-item flex flex-col items-center p-2 rounded cursor-pointer" onclick="openApp('spotify')">
                <i class="fa-brands fa-spotify text-green-500 text-3xl mb-2"></i>
                <span class="text-xs text-gray-700">Spotify</span>
            </div>
            <div class="app-grid-item flex flex-col items-center p-2 rounded cursor-pointer" onclick="openApp('vscode')">
                <i class="fa-solid fa-code text-blue-600 text-3xl mb-2"></i>
                <span class="text-xs text-gray-700">VS Code</span>
            </div>
        </div>

        <!-- Recommended Section -->
        <div class="flex justify-between items-center mb-4 mt-auto">
            <span class="text-sm font-bold text-gray-700">建議</span>
            <button class="text-xs bg-white border px-2 py-1 rounded hover:bg-gray-50 shadow-sm flex items-center gap-1">更多 <i class="fa-solid fa-chevron-right text-[10px]"></i></button>
        </div>
        <div class="grid grid-cols-2 gap-2 mb-8">
            <div class="flex items-center gap-3 p-2 hover:bg-white/50 rounded cursor-pointer">
                <i class="fa-regular fa-file-word text-blue-700 text-xl"></i>
                <div class="flex flex-col">
                    <span class="text-xs font-medium">履歷表.docx</span>
                    <span class="text-[10px] text-gray-500">2 小時前</span>
                </div>
            </div>
            <div class="flex items-center gap-3 p-2 hover:bg-white/50 rounded cursor-pointer">
                <i class="fa-regular fa-file-image text-purple-600 text-xl"></i>
                <div class="flex flex-col">
                    <span class="text-xs font-medium">假期照片.jpg</span>
                    <span class="text-[10px] text-gray-500">昨天</span>
                </div>
            </div>
             <div class="flex items-center gap-3 p-2 hover:bg-white/50 rounded cursor-pointer">
                <i class="fa-solid fa-file-pdf text-red-600 text-xl"></i>
                <div class="flex flex-col">
                    <span class="text-xs font-medium">專案計畫書.pdf</span>
                    <span class="text-[10px] text-gray-500">上週</span>
                </div>
            </div>
             <div class="flex items-center gap-3 p-2 hover:bg-white/50 rounded cursor-pointer">
                <i class="fa-brands fa-github text-black text-xl"></i>
                <div class="flex flex-col">
                    <span class="text-xs font-medium">開始使用 GitHub</span>
                    <span class="text-[10px] text-gray-500">最近新增</span>
                </div>
            </div>
        </div>

        <!-- Bottom User Bar -->
        <div class="border-t border-gray-300/50 pt-4 flex justify-between items-center px-2">
            <div class="flex items-center gap-3 hover:bg-white/50 p-2 rounded cursor-pointer transition-colors">
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xs">U</div>
                <span class="text-sm font-medium text-gray-700">User</span>
            </div>
            <div class="p-2 hover:bg-white/50 rounded cursor-pointer transition-colors" title="電源" onclick="window.location.reload()">
                <i class="fa-solid fa-power-off text-gray-700"></i>
            </div>
        </div>
    </div>

    <!-- 7. Action Center / Calendar (Mock) -->
    <div id="calendar-flyout" class="fixed bottom-14 right-4 w-80 h-96 glass rounded-lg shadow-2xl z-50 hidden p-4">
         <div class="text-sm font-medium text-gray-500 mb-2">2025年 11月 21日</div>
         <div class="text-2xl font-light text-gray-800 mb-4">星期五</div>
         <div class="h-px bg-gray-300 mb-4"></div>
         <div class="text-center text-gray-400 text-sm mt-10">沒有新的通知</div>
    </div>

    <!-- 8. Taskbar -->
    <div id="taskbar" class="fixed bottom-0 w-full h-12 glass z-[100] flex justify-between items-center px-2">
        <!-- Widgets Placeholder (Left) -->
        <div class="w-1/3 flex items-center pl-2">
            <div class="flex items-center gap-2 text-xs text-gray-700 hover:bg-white/40 px-2 py-1 rounded cursor-default transition-colors">
                <i class="fa-solid fa-cloud-sun text-yellow-500"></i>
                <span class="font-medium">26°C 多雲</span>
            </div>
        </div>

        <!-- Center Icons -->
        <div class="flex items-center gap-1 h-full">
            <div class="w-10 h-10 flex items-center justify-center rounded taskbar-icon-hover cursor-pointer transition-all active:scale-90" onclick="toggleStartMenu()" title="開始">
                <i class="fa-brands fa-windows text-blue-600 text-xl"></i>
            </div>
            <div class="w-10 h-10 flex items-center justify-center rounded taskbar-icon-hover cursor-pointer transition-all active:scale-90" title="搜尋">
                <i class="fa-solid fa-magnifying-glass text-gray-700 text-lg"></i>
            </div>
            <div class="w-10 h-10 flex items-center justify-center rounded taskbar-icon-hover cursor-pointer transition-all active:scale-90" title="工作檢視">
                 <div class="w-4 h-4 border-2 border-gray-700 rounded-sm flex">
                    <div class="w-1/2 h-full bg-gray-700"></div>
                 </div>
            </div>
            <div class="w-10 h-10 flex items-center justify-center rounded taskbar-icon-hover cursor-pointer transition-all active:scale-90" onclick="openApp('explorer')" title="檔案總管">
                <i class="fa-solid fa-folder-closed text-yellow-500 text-xl"></i>
            </div>
            <div class="w-10 h-10 flex items-center justify-center rounded taskbar-icon-hover cursor-pointer transition-all active:scale-90" onclick="openApp('edge')" title="Microsoft Edge">
                <i class="fa-brands fa-edge text-blue-500 text-xl"></i>
            </div>
             <div class="w-10 h-10 flex items-center justify-center rounded taskbar-icon-hover cursor-pointer transition-all active:scale-90" onclick="openApp('store')" title="Microsoft Store">
                <i class="fa-solid fa-bag-shopping text-blue-400 text-xl"></i>
            </div>
        </div>

        <!-- System Tray (Right) -->
        <div class="w-1/3 flex justify-end items-center h-full pr-2">
            <div class="flex items-center gap-2 px-2 py-1 rounded hover:bg-white/40 cursor-default transition-colors" title="系統狀態">
                <i class="fa-solid fa-chevron-up text-xs text-gray-600"></i>
            </div>
            <div class="flex items-center gap-3 px-2 py-1 rounded hover:bg-white/40 cursor-pointer transition-colors" title="網路與音量">
                <i class="fa-solid fa-wifi text-xs text-gray-700"></i>
                <i class="fa-solid fa-volume-high text-xs text-gray-700"></i>
                <i class="fa-solid fa-battery-three-quarters text-xs text-gray-700 transform rotate-180"></i>
            </div>
            <div class="flex flex-col items-end justify-center px-2 py-1 rounded hover:bg-white/40 cursor-pointer transition-colors ml-1" onclick="toggleCalendar()" title="時間與日期">
                <span id="clock-time" class="text-xs text-gray-800 font-medium leading-none mb-0.5">12:00</span>
                <span id="clock-date" class="text-xs text-gray-800 leading-none">2025/11/21</span>
            </div>
             <div class="w-1 h-full border-l border-gray-400/30 ml-2 hover:bg-white/50 cursor-pointer" onclick="minimizeAll()" title="顯示桌面"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        /* --- State & Configuration --- */
        const state = {
            windows: [],
            nextZIndex: 100,
            activeWindow: null,
            startMenuOpen: false,
            calendarOpen: false,
        };

        const apps = {
            explorer: {
                title: "檔案總管",
                icon: "fa-solid fa-folder-closed text-yellow-500",
                width: 800,
                height: 500,
                content: `
                    <div class="flex h-full bg-[#f3f3f3]">
                        <!-- Sidebar -->
                        <div class="w-48 flex-shrink-0 border-r border-gray-200 p-2 bg-[#f3f3f3] text-sm">
                             <div class="p-1 hover:bg-gray-200 rounded mb-1 flex items-center gap-2 cursor-pointer"><i class="fa-solid fa-house text-blue-500 w-4"></i> 首頁</div>
                             <div class="p-1 hover:bg-gray-200 rounded mb-1 flex items-center gap-2 cursor-pointer"><i class="fa-brands fa-onedrive text-blue-400 w-4"></i> OneDrive</div>
                             <div class="border-t border-gray-300 my-2"></div>
                             <div class="p-1 bg-blue-100 text-blue-700 rounded mb-1 flex items-center gap-2 font-medium cursor-pointer"><i class="fa-solid fa-desktop w-4"></i> 本機</div>
                             <div class="pl-6 p-1 hover:bg-gray-200 rounded mb-1 cursor-pointer flex items-center gap-2"><i class="fa-solid fa-desktop text-blue-400 w-3"></i> 桌面</div>
                             <div class="pl-6 p-1 hover:bg-gray-200 rounded mb-1 cursor-pointer flex items-center gap-2"><i class="fa-solid fa-download text-green-500 w-3"></i> 下載</div>
                             <div class="pl-6 p-1 hover:bg-gray-200 rounded mb-1 cursor-pointer flex items-center gap-2"><i class="fa-solid fa-file text-yellow-500 w-3"></i> 文件</div>
                             <div class="pl-6 p-1 hover:bg-gray-200 rounded mb-1 cursor-pointer flex items-center gap-2"><i class="fa-solid fa-image text-purple-500 w-3"></i> 圖片</div>
                        </div>
                        <!-- Main Content -->
                        <div class="flex-1 flex flex-col bg-white">
                            <!-- Toolbar -->
                            <div class="h-12 border-b border-gray-200 flex items-center px-4 gap-4 bg-[#fbfbfb]">
                                <div class="flex gap-2 text-gray-500">
                                    <i class="fa-solid fa-arrow-left hover:bg-gray-200 p-1 rounded cursor-pointer"></i>
                                    <i class="fa-solid fa-arrow-right hover:bg-gray-200 p-1 rounded cursor-pointer"></i>
                                    <i class="fa-solid fa-arrow-up hover:bg-gray-200 p-1 rounded cursor-pointer"></i>
                                </div>
                                <div class="flex-1 border border-gray-300 rounded px-2 py-1 text-sm flex items-center bg-white">
                                    <i class="fa-solid fa-desktop text-gray-400 mr-2"></i> 本機
                                </div>
                                <div class="w-48 border border-gray-300 rounded px-2 py-1 text-sm bg-white text-gray-400">
                                    搜尋本機
                                </div>
                            </div>
                            <!-- Toolbar 2 -->
                            <div class="h-10 border-b border-gray-200 flex items-center px-2 gap-1 text-sm text-gray-700 bg-[#fbfbfb]">
                                <div class="px-2 py-1 hover:bg-gray-200 rounded cursor-pointer flex items-center gap-2"><i class="fa-solid fa-plus text-blue-500"></i> 新增</div>
                                <div class="w-px h-4 bg-gray-300 mx-1"></div>
                                <div class="px-2 py-1 hover:bg-gray-200 rounded cursor-pointer"><i class="fa-solid fa-scissors"></i></div>
                                <div class="px-2 py-1 hover:bg-gray-200 rounded cursor-pointer"><i class="fa-regular fa-copy"></i></div>
                                <div class="px-2 py-1 hover:bg-gray-200 rounded cursor-pointer"><i class="fa-solid fa-paste"></i></div>
                                <div class="px-2 py-1 hover:bg-gray-200 rounded cursor-pointer"><i class="fa-regular fa-trash-can"></i></div>
                                <div class="w-px h-4 bg-gray-300 mx-1"></div>
                                <div class="px-2 py-1 hover:bg-gray-200 rounded cursor-pointer flex items-center gap-1"><i class="fa-solid fa-list"></i> 檢視</div>
                            </div>
                            <!-- Files Grid -->
                            <div class="flex-1 p-4 overflow-auto">
                                <div class="mb-4 text-sm font-medium text-gray-600 flex items-center gap-2">裝置和磁碟機 (2) <div class="h-px bg-gray-200 flex-1"></div></div>
                                <div class="grid grid-cols-4 gap-4">
                                    <div class="flex gap-3 items-center p-2 hover:bg-blue-50 hover:outline hover:outline-1 hover:outline-blue-200 rounded cursor-pointer">
                                        <i class="fa-brands fa-windows text-4xl text-blue-500"></i>
                                        <div class="flex flex-col">
                                            <span class="text-sm font-medium text-gray-700">Windows (C:)</span>
                                            <div class="w-24 h-3 bg-gray-200 rounded-full mt-1 overflow-hidden">
                                                <div class="h-full bg-blue-500 w-3/4"></div>
                                            </div>
                                            <span class="text-[10px] text-gray-500">剩餘 150 GB / 共 500 GB</span>
                                        </div>
                                    </div>
                                     <div class="flex gap-3 items-center p-2 hover:bg-blue-50 hover:outline hover:outline-1 hover:outline-blue-200 rounded cursor-pointer">
                                        <i class="fa-solid fa-hard-drive text-4xl text-gray-400"></i>
                                        <div class="flex flex-col">
                                            <span class="text-sm font-medium text-gray-700">Data (D:)</span>
                                            <div class="w-24 h-3 bg-gray-200 rounded-full mt-1 overflow-hidden">
                                                <div class="h-full bg-blue-500 w-1/2"></div>
                                            </div>
                                            <span class="text-[10px] text-gray-500">剩餘 500 GB / 共 1 TB</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            edge: {
                title: "新索引標籤 - Microsoft Edge",
                icon: "fa-brands fa-edge text-blue-500",
                width: 900,
                height: 600,
                content: `
                    <div class="flex flex-col h-full bg-white">
                         <div class="h-9 bg-[#f7f7f7] flex items-center px-2 border-b border-gray-200">
                            <i class="fa-solid fa-arrow-rotate-right p-2 text-gray-600 text-sm hover:bg-gray-200 rounded-full cursor-pointer"></i>
                            <i class="fa-solid fa-house p-2 text-gray-600 text-sm hover:bg-gray-200 rounded-full cursor-pointer"></i>
                            <div class="flex-1 bg-white border border-gray-200 rounded-full h-7 mx-2 px-3 flex items-center text-sm text-gray-600 shadow-sm">
                                <i class="fa-solid fa-lock text-xs mr-2 text-green-600"></i> https://www.bing.com
                            </div>
                         </div>
                         <div class="flex-1 flex flex-col items-center justify-center bg-[url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?ixlib=rb-1.2.1&auto=format&fit=crop&w=1000&q=80')] bg-cover bg-center relative">
                            <div class="absolute inset-0 bg-black/20"></div>
                            <div class="z-10 text-white text-6xl font-bold mb-8 drop-shadow-lg">Bing</div>
                            <div class="z-10 w-1/2 h-12 bg-white rounded-full flex items-center px-4 shadow-lg">
                                <input type="text" class="flex-1 outline-none text-gray-700" placeholder="搜尋網路">
                                <i class="fa-solid fa-magnifying-glass text-blue-500 text-lg cursor-pointer"></i>
                            </div>
                         </div>
                    </div>
                `
            },
            notepad: {
                title: "未命名 - 記事本",
                icon: "fa-solid fa-note-sticky text-blue-400",
                width: 600,
                height: 400,
                content: `
                    <div class="flex flex-col h-full bg-white">
                        <div class="h-8 flex items-center px-1 text-xs text-gray-700 border-b border-gray-100">
                            <div class="px-2 py-1 hover:bg-gray-100 rounded cursor-pointer">檔案(F)</div>
                            <div class="px-2 py-1 hover:bg-gray-100 rounded cursor-pointer">編輯(E)</div>
                            <div class="px-2 py-1 hover:bg-gray-100 rounded cursor-pointer">格式(O)</div>
                            <div class="px-2 py-1 hover:bg-gray-100 rounded cursor-pointer">檢視(V)</div>
                            <div class="px-2 py-1 hover:bg-gray-100 rounded cursor-pointer">說明(H)</div>
                        </div>
                        <textarea class="flex-1 p-2 outline-none resize-none font-mono text-sm" placeholder="在此輸入文字..."></textarea>
                        <div class="h-6 bg-[#f3f3f3] border-t border-gray-200 flex items-center px-2 text-xs text-gray-500 justify-end gap-4">
                            <span>Ln 1, Col 1</span>
                            <span>100%</span>
                            <span>Windows (CRLF)</span>
                            <span>UTF-8</span>
                        </div>
                    </div>
                `
            },
            calculator: {
                title: "小算盤",
                icon: "fa-solid fa-calculator text-gray-600",
                width: 320,
                height: 500,
                content: `
                    <div class="flex flex-col h-full bg-[#f3f3f3]">
                        <div class="h-12 flex items-center px-4 font-bold text-lg">標準</div>
                        <div class="flex-1 flex flex-col p-1">
                            <div class="h-24 flex items-end justify-end text-4xl font-medium px-4 pb-2 select-text">0</div>
                            <div class="grid grid-cols-4 gap-1 flex-1">
                                <button class="bg-white hover:bg-gray-100 rounded text-sm">MC</button>
                                <button class="bg-white hover:bg-gray-100 rounded text-sm">MR</button>
                                <button class="bg-white hover:bg-gray-100 rounded text-sm">M+</button>
                                <button class="bg-white hover:bg-gray-100 rounded text-sm">M-</button>
                                
                                <button class="bg-white hover:bg-gray-100 rounded text-sm">%</button>
                                <button class="bg-white hover:bg-gray-100 rounded text-sm">CE</button>
                                <button class="bg-white hover:bg-gray-100 rounded text-sm">C</button>
                                <button class="bg-white hover:bg-gray-100 rounded text-sm"><i class="fa-solid fa-delete-left"></i></button>

                                <button class="bg-[#fbfbfb] hover:bg-white rounded font-bold">7</button>
                                <button class="bg-[#fbfbfb] hover:bg-white rounded font-bold">8</button>
                                <button class="bg-[#fbfbfb] hover:bg-white rounded font-bold">9</button>
                                <button class="bg-white hover:bg-gray-100 rounded text-lg">×</button>

                                <button class="bg-[#fbfbfb] hover:bg-white rounded font-bold">4</button>
                                <button class="bg-[#fbfbfb] hover:bg-white rounded font-bold">5</button>
                                <button class="bg-[#fbfbfb] hover:bg-white rounded font-bold">6</button>
                                <button class="bg-white hover:bg-gray-100 rounded text-lg">-</button>

                                <button class="bg-[#fbfbfb] hover:bg-white rounded font-bold">1</button>
                                <button class="bg-[#fbfbfb] hover:bg-white rounded font-bold">2</button>
                                <button class="bg-[#fbfbfb] hover:bg-white rounded font-bold">3</button>
                                <button class="bg-white hover:bg-gray-100 rounded text-lg">+</button>

                                <button class="bg-[#fbfbfb] hover:bg-white rounded font-bold">+/-</button>
                                <button class="bg-[#fbfbfb] hover:bg-white rounded font-bold">0</button>
                                <button class="bg-[#fbfbfb] hover:bg-white rounded font-bold">.</button>
                                <button class="bg-blue-500 hover:bg-blue-600 text-white rounded text-lg">=</button>
                            </div>
                        </div>
                    </div>
                `
            },
            settings: {
                title: "設定",
                icon: "fa-solid fa-gear text-gray-500",
                width: 900,
                height: 600,
                content: `
                     <div class="flex h-full bg-[#f3f3f3]">
                        <!-- Sidebar -->
                        <div class="w-64 flex-shrink-0 p-4 bg-[#f3f3f3] flex flex-col gap-1">
                             <div class="flex items-center gap-3 mb-4 px-2">
                                <div class="w-8 h-8 bg-blue-600 rounded-full text-white flex items-center justify-center text-xs">U</div>
                                <div class="flex flex-col">
                                    <span class="text-sm font-bold">User</span>
                                    <span class="text-xs text-gray-500">Local Account</span>
                                </div>
                             </div>
                             <div class="relative mb-4">
                                <i class="fa-solid fa-magnifying-glass absolute left-3 top-2.5 text-gray-400 text-xs"></i>
                                <input type="text" placeholder="尋找設定" class="w-full bg-white border border-gray-300 rounded py-1.5 pl-8 pr-2 text-sm outline-none focus:border-blue-500">
                             </div>

                             <div class="p-2 bg-white rounded shadow-sm flex items-center gap-3 cursor-pointer"><i class="fa-solid fa-laptop text-blue-500 w-4"></i> <span class="text-sm">系統</span></div>
                             <div class="p-2 hover:bg-gray-200 rounded flex items-center gap-3 cursor-pointer"><i class="fa-brands fa-bluetooth-b text-blue-500 w-4"></i> <span class="text-sm">藍牙與裝置</span></div>
                             <div class="p-2 hover:bg-gray-200 rounded flex items-center gap-3 cursor-pointer"><i class="fa-solid fa-globe text-blue-500 w-4"></i> <span class="text-sm">網路和網際網路</span></div>
                             <div class="p-2 hover:bg-gray-200 rounded flex items-center gap-3 cursor-pointer"><i class="fa-solid fa-wand-magic-sparkles text-blue-500 w-4"></i> <span class="text-sm">個人化</span></div>
                             <div class="p-2 hover:bg-gray-200 rounded flex items-center gap-3 cursor-pointer"><i class="fa-solid fa-gamepad text-blue-500 w-4"></i> <span class="text-sm">遊戲</span></div>
                             <div class="p-2 hover:bg-gray-200 rounded flex items-center gap-3 cursor-pointer"><i class="fa-solid fa-universal-access text-blue-500 w-4"></i> <span class="text-sm">無障礙設定</span></div>
                             <div class="p-2 hover:bg-gray-200 rounded flex items-center gap-3 cursor-pointer"><i class="fa-solid fa-shield-halved text-blue-500 w-4"></i> <span class="text-sm">隱私權與安全性</span></div>
                             <div class="p-2 hover:bg-gray-200 rounded flex items-center gap-3 cursor-pointer"><i class="fa-solid fa-rotate text-blue-500 w-4"></i> <span class="text-sm">Windows Update</span></div>
                        </div>

                        <!-- Content -->
                        <div class="flex-1 p-8 overflow-auto bg-[#fafafa]">
                            <h1 class="text-2xl font-semibold mb-6">系統</h1>
                            
                            <div class="bg-white rounded-lg border border-gray-200 p-4 mb-4 flex items-center gap-4 shadow-sm">
                                <i class="fa-solid fa-laptop text-4xl text-gray-400"></i>
                                <div>
                                    <div class="font-bold text-lg">Desktop-TW886</div>
                                    <div class="text-sm text-gray-500">Windows 11 Pro - 23H2</div>
                                </div>
                                <button class="ml-auto border border-gray-300 px-3 py-1 rounded hover:bg-gray-50 text-sm">重新命名</button>
                            </div>

                            <div class="bg-white rounded-lg border border-gray-200 overflow-hidden shadow-sm">
                                <div class="p-4 hover:bg-gray-50 cursor-pointer flex items-center justify-between border-b border-gray-100">
                                    <div class="flex items-center gap-4">
                                        <i class="fa-solid fa-display text-lg text-gray-500 w-6"></i>
                                        <div>
                                            <div class="text-sm font-medium">顯示器</div>
                                            <div class="text-xs text-gray-500">螢幕、亮度、夜間光線、顯示設定檔</div>
                                        </div>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-gray-400 text-xs"></i>
                                </div>
                                <div class="p-4 hover:bg-gray-50 cursor-pointer flex items-center justify-between border-b border-gray-100">
                                    <div class="flex items-center gap-4">
                                        <i class="fa-solid fa-volume-high text-lg text-gray-500 w-6"></i>
                                        <div>
                                            <div class="text-sm font-medium">音效</div>
                                            <div class="text-xs text-gray-500">音量、輸出、輸入、音效裝置</div>
                                        </div>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-gray-400 text-xs"></i>
                                </div>
                                <div class="p-4 hover:bg-gray-50 cursor-pointer flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <i class="fa-solid fa-bell text-lg text-gray-500 w-6"></i>
                                        <div>
                                            <div class="text-sm font-medium">通知</div>
                                            <div class="text-xs text-gray-500">應用程式和系統的警示</div>
                                        </div>
                                    </div>
                                    <i class="fa-solid fa-chevron-right text-gray-400 text-xs"></i>
                                </div>
                            </div>
                        </div>
                     </div>
                `
            },
            vscode: {
                title: "Visual Studio Code",
                icon: "fa-solid fa-code text-blue-600",
                width: 1000,
                height: 700,
                content: `
                    <div class="flex flex-col h-full bg-[#1e1e1e] text-[#cccccc]">
                        <!-- Title bar mock inside app (since system has its own) -->
                        <div class="flex h-full">
                             <!-- Activity Bar -->
                             <div class="w-12 flex flex-col items-center py-2 gap-4 border-r border-[#333333]">
                                <i class="fa-regular fa-file text-2xl text-white cursor-pointer"></i>
                                <i class="fa-solid fa-magnifying-glass text-2xl text-gray-500 hover:text-white cursor-pointer"></i>
                                <i class="fa-solid fa-code-branch text-2xl text-gray-500 hover:text-white cursor-pointer"></i>
                                <i class="fa-solid fa-bug text-2xl text-gray-500 hover:text-white cursor-pointer"></i>
                                <i class="fa-solid fa-border-all text-2xl text-gray-500 hover:text-white cursor-pointer"></i>
                                <div class="flex-1"></div>
                                <i class="fa-solid fa-gear text-2xl text-gray-500 hover:text-white cursor-pointer"></i>
                             </div>
                             <!-- Sidebar -->
                             <div class="w-60 bg-[#252526] flex flex-col">
                                <div class="px-4 py-2 text-xs font-bold uppercase text-gray-400">Explorer</div>
                                <div class="px-4 py-1 bg-[#37373d] text-white text-sm flex items-center"><i class="fa-solid fa-angle-down text-xs mr-2"></i> PROJECT</div>
                                <div class="pl-6 py-1 hover:bg-[#2a2d2e] cursor-pointer flex items-center gap-2 text-sm text-blue-300"><i class="fa-brands fa-html5"></i> index.html</div>
                                <div class="pl-6 py-1 hover:bg-[#2a2d2e] cursor-pointer flex items-center gap-2 text-sm text-yellow-300"><i class="fa-brands fa-js"></i> script.js</div>
                                <div class="pl-6 py-1 hover:bg-[#2a2d2e] cursor-pointer flex items-center gap-2 text-sm text-blue-200"><i class="fa-brands fa-css3-alt"></i> style.css</div>
                             </div>
                             <!-- Editor -->
                             <div class="flex-1 bg-[#1e1e1e] flex flex-col">
                                <div class="flex bg-[#2d2d2d]">
                                    <div class="px-3 py-2 bg-[#1e1e1e] text-white text-sm border-t-2 border-blue-500 flex items-center gap-2">
                                        <i class="fa-brands fa-html5 text-orange-500"></i> index.html <i class="fa-solid fa-xmark ml-2 text-xs hover:bg-gray-700 rounded p-0.5"></i>
                                    </div>
                                </div>
                                <div class="flex-1 p-4 font-mono text-sm">
                                    <div><span class="text-blue-400">&lt;!DOCTYPE</span> <span class="text-orange-400">html</span>&gt;</div>
                                    <div><span class="text-blue-400">&lt;html&gt;</span></div>
                                    <div class="pl-4"><span class="text-blue-400">&lt;body&gt;</span></div>
                                    <div class="pl-8"><span class="text-blue-400">&lt;h1&gt;</span>Hello World<span class="text-blue-400">&lt;/h1&gt;</span></div>
                                    <div class="pl-4"><span class="text-blue-400">&lt;/body&gt;</span></div>
                                    <div><span class="text-blue-400">&lt;/html&gt;</span></div>
                                    <div class="mt-4 text-green-600">// Welcome to Windows 11 Web Edition</div>
                                </div>
                             </div>
                        </div>
                        <!-- Status Bar -->
                        <div class="h-6 bg-[#007acc] flex items-center px-2 text-xs text-white justify-between">
                            <div class="flex gap-3">
                                <span><i class="fa-solid fa-code-branch text-[10px]"></i> main</span>
                                <span><i class="fa-regular fa-circle-xmark text-[10px]"></i> 0</span>
                                <span><i class="fa-solid fa-triangle-exclamation text-[10px]"></i> 0</span>
                            </div>
                            <div class="flex gap-3">
                                <span>Ln 6, Col 1</span>
                                <span>UTF-8</span>
                                <span>HTML</span>
                            </div>
                        </div>
                    </div>
                `
            },
            store: {
                 title: "Microsoft Store",
                 icon: "fa-brands fa-windows text-blue-400",
                 width: 900,
                 height: 600,
                 content: `
                    <div class="flex h-full bg-[#f3f3f3]">
                        <div class="w-48 p-4 flex flex-col gap-2">
                            <div class="p-2 bg-gray-200 rounded cursor-pointer font-medium"><i class="fa-solid fa-house mr-2"></i> 首頁</div>
                            <div class="p-2 hover:bg-gray-200 rounded cursor-pointer"><i class="fa-solid fa-gamepad mr-2"></i> 遊戲</div>
                            <div class="p-2 hover:bg-gray-200 rounded cursor-pointer"><i class="fa-solid fa-film mr-2"></i> 電影與電視</div>
                            <div class="p-2 hover:bg-gray-200 rounded cursor-pointer"><i class="fa-solid fa-layer-group mr-2"></i> 應用程式</div>
                            <div class="mt-auto p-2 hover:bg-gray-200 rounded cursor-pointer"><i class="fa-solid fa-download mr-2"></i> 媒體櫃</div>
                        </div>
                        <div class="flex-1 p-6 overflow-y-auto">
                            <div class="bg-gradient-to-r from-purple-500 to-blue-500 h-48 rounded-lg mb-6 p-6 text-white shadow-lg flex flex-col justify-center items-start">
                                <h1 class="text-3xl font-bold mb-2">必備應用程式</h1>
                                <p class="mb-4">提升您的生產力</p>
                                <button class="bg-white text-black px-4 py-1.5 rounded font-medium shadow hover:bg-gray-100">立即查看</button>
                            </div>
                            
                            <h2 class="font-bold text-lg mb-4">熱門免費應用程式</h2>
                            <div class="grid grid-cols-3 gap-4">
                                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:-translate-y-1 transition-transform cursor-pointer">
                                    <div class="w-12 h-12 bg-green-500 rounded mb-2 flex items-center justify-center text-white text-2xl"><i class="fa-brands fa-spotify"></i></div>
                                    <div class="font-bold text-sm">Spotify Music</div>
                                    <div class="text-xs text-gray-500">音樂</div>
                                    <button class="mt-2 bg-blue-600 text-white text-xs px-3 py-1 rounded-full">取得</button>
                                </div>
                                <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:-translate-y-1 transition-transform cursor-pointer">
                                    <div class="w-12 h-12 bg-red-600 rounded mb-2 flex items-center justify-center text-white text-2xl"><i class="fa-brands fa-netflix"></i></div>
                                    <div class="font-bold text-sm">Netflix</div>
                                    <div class="text-xs text-gray-500">娛樂</div>
                                    <button class="mt-2 bg-blue-600 text-white text-xs px-3 py-1 rounded-full">取得</button>
                                </div>
                                 <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:-translate-y-1 transition-transform cursor-pointer">
                                    <div class="w-12 h-12 bg-blue-400 rounded mb-2 flex items-center justify-center text-white text-2xl"><i class="fa-brands fa-telegram"></i></div>
                                    <div class="font-bold text-sm">Telegram</div>
                                    <div class="text-xs text-gray-500">社群</div>
                                    <button class="mt-2 bg-blue-600 text-white text-xs px-3 py-1 rounded-full">取得</button>
                                </div>
                            </div>
                        </div>
                    </div>
                 `
            }
        };

        /* --- Desktop Icons Data --- */
        const desktopIcons = [
            { id: 'icon-pc', name: '本機', icon: 'fa-solid fa-desktop text-blue-400', action: 'explorer' },
            { id: 'icon-bin', name: '資源回收筒', icon: 'fa-solid fa-trash-can text-gray-400', action: null },
            { id: 'icon-edge', name: 'Microsoft Edge', icon: 'fa-brands fa-edge text-blue-500', action: 'edge' },
            { id: 'icon-folder', name: '新增資料夾', icon: 'fa-solid fa-folder text-yellow-400', action: 'explorer' },
            { id: 'icon-vscode', name: 'Visual Studio Code', icon: 'fa-solid fa-code text-blue-600', action: 'vscode' },
             { id: 'icon-txt', name: '待辦事項.txt', icon: 'fa-solid fa-file-lines text-gray-200', action: 'notepad' },
        ];

        /* --- Initialization --- */
        window.onload = () => {
            renderDesktopIcons();
            updateClock();
            setInterval(updateClock, 1000);
            
            // Boot animation simulation
            setTimeout(() => {
                const boot = document.getElementById('boot-screen');
                boot.style.opacity = '0';
                setTimeout(() => {
                    boot.remove();
                    playStartupSound(); // Optional
                }, 1000);
            }, 2500);

            // Global Event Listeners
            document.addEventListener('click', handleGlobalClick);
            document.addEventListener('contextmenu', handleContextMenu);
        };

         function playStartupSound() {
            console.log("Windows 11 啟動音效 (模擬)");
            // 由於瀏覽器自動播放策略，這裡僅做 Log 處理以修復錯誤
        }

        /* --- Logic: Clock --- */
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
            const dateStr = now.toLocaleDateString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit' });
            document.getElementById('clock-time').innerText = timeStr;
            document.getElementById('clock-date').innerText = dateStr;
        }

        /* --- Logic: Desktop --- */
        function renderDesktopIcons() {
            const container = document.getElementById('desktop');
            container.innerHTML = '';
            desktopIcons.forEach(icon => {
                const el = document.createElement('div');
                el.className = 'desktop-icon w-24 h-24';
                el.setAttribute('data-id', icon.id);
                el.onclick = (e) => {
                    e.stopPropagation();
                    selectIcon(el);
                };
                el.ondblclick = () => {
                    if(icon.action) openApp(icon.action);
                };
                el.innerHTML = `
                    <i class="${icon.icon} text-4xl mb-2 drop-shadow-md"></i>
                    <span class="text-xs text-center line-clamp-2 leading-tight">${icon.name}</span>
                `;
                container.appendChild(el);
            });
        }

        function selectIcon(el) {
            document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
        }

        function refreshDesktop() {
            const container = document.getElementById('desktop');
            container.style.opacity = '0';
            setTimeout(() => {
                renderDesktopIcons();
                container.style.opacity = '1';
            }, 100);
            hideContextMenu();
        }

        /* --- Logic: Context Menu --- */
        function handleContextMenu(e) {
            e.preventDefault();
            const menu = document.getElementById('context-menu');
            // simple boundary check
            let x = e.clientX;
            let y = e.clientY;
            if(x + 256 > window.innerWidth) x -= 256;
            if(y + 300 > window.innerHeight) y -= 300;

            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.classList.remove('hidden');
            requestAnimationFrame(() => {
                menu.style.opacity = '1';
                menu.style.transform = 'scale(1)';
            });
        }

        function hideContextMenu() {
            const menu = document.getElementById('context-menu');
            menu.style.opacity = '0';
            menu.style.transform = 'scale(0.95)';
            setTimeout(() => menu.classList.add('hidden'), 100);
        }

        /* --- Logic: Start Menu & Calendar --- */
        function toggleStartMenu() {
            const menu = document.getElementById('start-menu');
            const calendar = document.getElementById('calendar-flyout');
            
            if (state.calendarOpen) toggleCalendar(); // Close calendar if open

            state.startMenuOpen = !state.startMenuOpen;
            if (state.startMenuOpen) {
                menu.classList.remove('start-menu-hidden');
            } else {
                menu.classList.add('start-menu-hidden');
            }
        }

         function toggleCalendar() {
            const menu = document.getElementById('start-menu');
            const calendar = document.getElementById('calendar-flyout');

            if (state.startMenuOpen) toggleStartMenu(); // Close start if open

            state.calendarOpen = !state.calendarOpen;
            if (state.calendarOpen) {
                calendar.classList.remove('hidden');
                // Small animation
                calendar.style.opacity = 0;
                calendar.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    calendar.style.opacity = 1;
                    calendar.style.transform = 'translateY(0)';
                }, 10);
            } else {
                calendar.classList.add('hidden');
            }
        }

        function handleGlobalClick(e) {
            const startMenu = document.getElementById('start-menu');
            const taskbarBtn = document.querySelector('[title="開始"]');
            const calendar = document.getElementById('calendar-flyout');
            const clock = document.getElementById('clock-time').parentElement;

            // Context menu click
            if (!e.target.closest('#context-menu')) hideContextMenu();

            // Start Menu click outside
            if (state.startMenuOpen && !startMenu.contains(e.target) && !taskbarBtn.contains(e.target)) {
                toggleStartMenu();
            }

            // Calendar click outside
            if (state.calendarOpen && !calendar.contains(e.target) && !clock.contains(e.target)) {
                toggleCalendar();
            }

            // Desktop icon deselect
            if (e.target.id === 'desktop' || e.target.id === 'wallpaper') {
                 document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
            }
        }

        /* --- Logic: Window Manager --- */
        function openApp(appId) {
            const appConfig = apps[appId] || apps['explorer']; // fallback
            const id = `win-${Date.now()}`;
            
            state.nextZIndex++;
            state.activeWindow = id;
            if(state.startMenuOpen) toggleStartMenu();

            // Randomize position slightly
            const randX = 50 + Math.random() * 50;
            const randY = 50 + Math.random() * 50;

            const win = document.createElement('div');
            win.id = id;
            win.className = 'window-frame window-opening glass-dark shadow-2xl text-black flex flex-col';
            win.style.width = `${appConfig.width}px`;
            win.style.height = `${appConfig.height}px`;
            win.style.top = `${randY}px`;
            win.style.left = `${randX}px`;
            win.style.zIndex = state.nextZIndex;
            // Mica background override for windows
            win.style.backgroundColor = "rgba(255, 255, 255, 0.97)"; 

            win.innerHTML = `
                <!-- Title Bar -->
                <div class="h-9 flex items-center justify-between px-3 select-none bg-white/50 border-b border-gray-200/50" onmousedown="startDrag(event, '${id}')">
                    <div class="flex items-center gap-3 text-xs font-medium text-gray-700">
                         <i class="${appConfig.icon}"></i>
                        <span>${appConfig.title}</span>
                    </div>
                    <div class="flex h-full items-center">
                        <div class="w-9 h-8 flex items-center justify-center hover:bg-gray-200 rounded transition-colors cursor-pointer no-drag" onclick="minimizeWindow('${id}')">
                            <i class="fa-solid fa-minus text-[10px] text-gray-600 pointer-events-none"></i>
                        </div>
                        <div class="w-9 h-8 flex items-center justify-center hover:bg-gray-200 rounded transition-colors cursor-pointer no-drag" onclick="maximizeWindow('${id}')">
                            <i class="fa-regular fa-square text-[10px] text-gray-600 pointer-events-none"></i>
                        </div>
                        <div class="w-9 h-8 flex items-center justify-center hover:bg-red-500 hover:text-white rounded transition-colors cursor-pointer no-drag" onclick="closeWindow('${id}')">
                            <i class="fa-solid fa-xmark text-sm text-gray-600 pointer-events-none"></i>
                        </div>
                    </div>
                </div>
                <!-- Content -->
                <div class="flex-1 relative overflow-hidden" onmousedown="focusWindow('${id}')">
                    ${appConfig.content}
                    <!-- Resize Handle (Simple corner) -->
                    <div class="absolute bottom-0 right-0 w-4 h-4 cursor-se-resize z-50" onmousedown="startResize(event, '${id}')"></div>
                </div>
            `;

            document.getElementById('windows-container').appendChild(win);
            state.windows.push({ id, minimized: false, maximized: false, preRect: {} });
            createTaskbarIndicator(id, appConfig.icon);
        }

        function closeWindow(id) {
            const win = document.getElementById(id);
            win.classList.add('window-closing');
            setTimeout(() => win.remove(), 200);
            
            state.windows = state.windows.filter(w => w.id !== id);
            const indicator = document.getElementById(`task-${id}`);
            if(indicator) indicator.remove();
        }

        function minimizeWindow(id) {
            const win = document.getElementById(id);
            win.classList.add('window-closing');
            setTimeout(() => {
                win.style.display = 'none';
                win.classList.remove('window-closing');
            }, 200);
            const winState = state.windows.find(w => w.id === id);
            if(winState) winState.minimized = true;
            updateTaskbarIndicator(id, false);
        }

        function maximizeWindow(id) {
            const win = document.getElementById(id);
            const winState = state.windows.find(w => w.id === id);
            
            if (!winState.maximized) {
                // Save previous state
                winState.preRect = {
                    top: win.style.top,
                    left: win.style.left,
                    width: win.style.width,
                    height: win.style.height
                };
                win.style.top = '0';
                win.style.left = '0';
                win.style.width = '100%';
                win.style.height = 'calc(100% - 48px)'; // minus taskbar
                win.style.borderRadius = '0';
                winState.maximized = true;
            } else {
                // Restore
                win.style.top = winState.preRect.top;
                win.style.left = winState.preRect.left;
                win.style.width = winState.preRect.width;
                win.style.height = winState.preRect.height;
                win.style.borderRadius = '8px';
                winState.maximized = false;
            }
        }

        function focusWindow(id) {
            const win = document.getElementById(id);
            if(win) {
                state.nextZIndex++;
                win.style.zIndex = state.nextZIndex;
                state.activeWindow = id;
                updateTaskbarIndicator(id, true);
            }
        }

        function restoreWindow(id) {
            const win = document.getElementById(id);
            const winState = state.windows.find(w => w.id === id);
            
            if(win.style.display === 'none') {
                win.style.display = 'flex';
                win.classList.add('window-opening');
                setTimeout(() => win.classList.remove('window-opening'), 200);
                winState.minimized = false;
            }
            focusWindow(id);
        }

        function minimizeAll() {
            state.windows.forEach(w => {
                if(!w.minimized) minimizeWindow(w.id);
            });
        }

        /* --- Logic: Dragging --- */
        let dragObj = null;

        function startDrag(e, id) {
            // Only drag if not maximized
            const winState = state.windows.find(w => w.id === id);
            if (winState && winState.maximized) return;

            // Only drag if target is titlebar, not buttons
            if(e.target.closest('.no-drag')) return;

            e.preventDefault();
            focusWindow(id);
            const win = document.getElementById(id);
            dragObj = {
                el: win,
                diffX: e.clientX - win.offsetLeft,
                diffY: e.clientY - win.offsetTop
            };
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function onDrag(e) {
            if (!dragObj) return;
            let x = e.clientX - dragObj.diffX;
            let y = e.clientY - dragObj.diffY;
            
            // Bounds
            if (y < 0) y = 0; // Don't go above screen
            
            dragObj.el.style.left = x + 'px';
            dragObj.el.style.top = y + 'px';
        }

        function stopDrag() {
            dragObj = null;
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', stopDrag);
        }

        /* --- Logic: Resizing --- */
        let resizeObj = null;

        function startResize(e, id) {
            e.preventDefault();
            const win = document.getElementById(id);
            resizeObj = {
                el: win,
                startX: e.clientX,
                startY: e.clientY,
                startW: parseInt(document.defaultView.getComputedStyle(win).width, 10),
                startH: parseInt(document.defaultView.getComputedStyle(win).height, 10)
            };
             document.addEventListener('mousemove', onResize);
             document.addEventListener('mouseup', stopResize);
        }

        function onResize(e) {
            if(!resizeObj) return;
            const newW = resizeObj.startW + (e.clientX - resizeObj.startX);
            const newH = resizeObj.startH + (e.clientY - resizeObj.startY);
            resizeObj.el.style.width = Math.max(300, newW) + 'px';
            resizeObj.el.style.height = Math.max(200, newH) + 'px';
        }

         function stopResize() {
            resizeObj = null;
            document.removeEventListener('mousemove', onResize);
            document.removeEventListener('mouseup', stopResize);
        }


        /* --- Logic: Taskbar Indicators --- */
        function createTaskbarIndicator(id, iconClass) {
            const tb = document.querySelector('#taskbar .flex.gap-1');
            const div = document.createElement('div');
            div.id = `task-${id}`;
            div.className = 'w-10 h-10 flex items-center justify-center rounded taskbar-icon-hover cursor-pointer transition-all bg-white/40 border-b-2 border-blue-500';
            div.innerHTML = `<i class="${iconClass} text-lg"></i>`;
            div.onclick = () => {
                const win = document.getElementById(id);
                if (win.style.display === 'none') {
                    restoreWindow(id);
                } else if (state.activeWindow === id) {
                    minimizeWindow(id);
                } else {
                    focusWindow(id);
                }
            };
            tb.appendChild(div);
        }

        function updateTaskbarIndicator(id, isActive) {
            const el = document.getElementById(`task-${id}`);
            if(!el) return;
            if(isActive) {
                el.classList.add('bg-white/40');
                el.classList.add('border-blue-500');
                el.classList.remove('border-transparent');
            } else {
                el.classList.remove('bg-white/40');
                el.classList.remove('border-blue-500');
                el.classList.add('border-transparent'); // Hidden indicator logic could be improved
                // But in Win11, minimized apps just lose the heavy background, still have the little line dot. 
                // Here we simplify to bottom border.
                el.classList.add('border-gray-400');
            }
        }

    </script>
</body>
</html>